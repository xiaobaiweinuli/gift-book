<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>礼簿展示屏</title>
    <script src="./static/tailwindcss.js"></script>
    <link href="./static/remixicon.css" rel="stylesheet" />

    <link rel="stylesheet" href="./static/pell.min.css" />

    <style>
      /* ==================== 主题变量 ==================== */
      :root,
      .theme-festive {
        --primary-color: #c00;
        --primary-border-color: #ffaaaa;
        --primary-bg-light: #fff2f2;
        --button-bg-color: #dc2626;
        --button-bg-hover: #b91c1c;
        --button-border-color: #dc2626;
        --button-text-color: #dc2626;
        --link-hover-bg: #fee2e2;
        --primary-ring-color: #ef4444;
      }

      .theme-solemn {
        --primary-color: #374151;
        --primary-border-color: #d1d5db;
        --primary-bg-light: #f3f4f6;
        --button-bg-color: #4b5563;
        --button-bg-hover: #375151;
        --button-border-color: #4b5563;
        --button-text-color: #4b5563;
        --link-hover-bg: #e5e7eb;
        --primary-ring-color: #4b5563;
      }

      body {
        font-family: "KaiTi", "楷体", serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
      }

      /* ==================== 动态布局 ==================== */
      #layout-root {
        display: flex;
        width: 100vw;
        height: 100vh;
      }

      #qr-code-area {
        width: 28%;
        flex-shrink: 0;
        background-color: #ffffff;
        border-right: 2px solid var(--primary-border-color);
        box-sizing: border-box;
        display: none; /* 默认隐藏，由 JS 控制显示 */
        flex-direction: column;
        align-items: center;
        /* 修改: 移除 justify-content: center 以允许 flex-grow 生效 */
        padding: 2rem 1.5rem;
      }

      #layout-root.layout-right #qr-code-area {
        border-right: none;
        border-left: 2px solid var(--primary-border-color);
      }

      #app-container {
        flex: 1;
        min-width: 0;
        height: 100%;
        position: relative;
      }

      /* ==================== 收款码区域样式 ==================== */
      .qr-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        width: 100%;
        min-height: 0;
        margin-bottom: 1.5rem;
        flex: 1;
      }

      .vertical-text {
        writing-mode: vertical-lr;
        text-orientation: mixed;
        font-size: clamp(1.5rem, 2vw, 2rem);
        font-weight: bold;
        color: var(--primary-color);
        letter-spacing: 6px;
        flex-shrink: 0;
      }

      .qr-container img {
        max-width: 80%;
        max-height: 100%;
        height: auto;
        object-fit: contain;
        border-radius: 8px;
        border: 4px solid var(--primary-border-color);
      }

      .custom-text-area {
        width: 100%;
        overflow: hidden; 
        padding-top: 1.5rem;
        margin-top: 1.5rem;
        border-top: 2px dashed var(--primary-border-color);
        font-family: "Microsoft YaHei", sans-serif;
        writing-mode: horizontal-tb;
        line-height: 1.6;
        font-size: 1rem;
      }

      /* ==================== 礼簿框架 (无修改) ==================== */
      .gift-book-frame {
        border: 6px solid var(--primary-color);
        padding: clamp(15px, 2vw, 30px);
        border-radius: 10px;
        background-color: var(--primary-bg-light);
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        box-sizing: border-box;
      }
      .gift-book-header {
        flex-shrink: 0;
        margin-bottom: clamp(10px, 1.5vh, 30px);
      }
      .gift-book-content {
        display: grid;
        grid-template-rows: 3fr 1fr 3fr;
        border-top: 3px solid var(--primary-border-color);
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }
      .gift-book-row {
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        width: 100%;
      }
      .book-cell {
        border-right: 3px solid var(--primary-border-color);
        border-bottom: 3px solid var(--primary-border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        writing-mode: vertical-lr;
        text-orientation: mixed;
        font-weight: bold;
        font-size: clamp(14px, 1.8vw, 32px);
        letter-spacing: clamp(4px, 0.8vw, 10px);
        padding: clamp(5px, 1vh, 15px) 0;
        overflow: hidden;
        text-align: center;
        position: relative;
        min-height: 0;
      }
      .book-cell:first-child {
        border-left: 3px solid var(--primary-border-color);
      }
      .name-cell .name {
        color: #333;
        padding: clamp(8px, 1.5vh, 20px) 0;
        text-align: center;
        white-space: nowrap;
        min-height: auto;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .latest-entry {
        animation: highlight-pulse 2s ease-in-out;
        background: linear-gradient(180deg, transparent, rgba(255, 215, 0, 0.2), transparent);
      }
      @keyframes highlight-pulse {
        0%,
        100% {
          background-color: transparent;
        }
        50% {
          background-color: rgba(255, 215, 0, 0.3);
        }
      }
      .type-cell {
        color: var(--primary-color);
        font-size: clamp(16px, 2vw, 28px);
        padding: clamp(8px, 1.5vh, 15px) 5px;
        font-family: "Source Han Serif CN Heavy", serif;
        font-weight: bold;
      }
      .amount-cell {
        color: #333;
        display: grid;
        grid-template-columns: 1fr auto;
        column-gap: clamp(5px, 1vw, 10px);
        justify-content: center;
        gap: clamp(5px, 1vh, 10px);
        padding: clamp(5px, 1vh, 10px) 0;
      }
      .amount-chinese {
        letter-spacing: clamp(1px, 0.3vw, 2px);
        text-align: center;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
      }
      .amount-numeric {
        color: #555;
        letter-spacing: 1px;
        writing-mode: lr;
        font-size: clamp(10px, 1.3vw, 18px);
        white-space: nowrap;
      }
      .amount-chinese.scale,
      .name.scale {
        font-size: clamp(12px, 1.5vw, 18px);
        letter-spacing: -1px;
        padding: clamp(3px, 0.5vh, 8px) 0;
      }
      .amount-numeric.scale {
        letter-spacing: 0.5px;
        font-size: clamp(9px, 1.2vw, 14px);
      }

      /* ==================== 顶部控件 (无修改) ==================== */
      #top-right-controls {
        position:absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      #fullscreen-btn,
      #settings-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #fullscreen-icon,
      #settings-icon {
        color: var(--primary-color);
      }
      #fullscreen-btn:hover,
      #settings-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }

      /* ==================== 全屏提示 (无修改) ==================== */
      #fullscreen-hint {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 30px;
        border-radius: 30px;
        font-size: 16px;
        z-index: 1000;
        animation: fade-in-out 5s forwards;
      }
      @keyframes fade-in-out {
        0%,
        100% {
          opacity: 0;
        }
        10%,
        90% {
          opacity: 1;
        }
      }

      /* ==================== 弹窗样式 (无修改) ==================== */
      #modal-container {
        font-family: "Inter", "Microsoft YaHei", sans-serif;
      }
      #modal {
        display: flex;
        flex-direction: column;
        max-height: 90vh;
        max-width: 700px;
        width: 90vw;
      }
      #modal-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
      }
      .themed-button-primary {
        background-color: var(--button-bg-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: bold;
      }
      .themed-button-primary:hover {
        background-color: var(--button-bg-hover);
      }
      .themed-button-secondary {
        border: 1px solid var(--button-border-color);
        color: var(--button-text-color);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: bold;
      }
      .themed-button-secondary:hover {
        background-color: var(--link-hover-bg);
      }
      .themed-ring:focus {
        --tw-ring-color: var(--primary-ring-color) !important;
        box-shadow: 0 0 0 2px var(--tw-ring-color);
        outline: none;
      }
      .themed-text-radio {
        color: var(--button-text-color);
      }

      /* ==================== Pell.js CDN 样式适配 (无修改) ==================== */
      .pell-content {
        height: 120px;
        outline: 0;
        overflow-y: auto;
        padding: 10px;
        font-family: "Microsoft YaHei", sans-serif;
        font-size: 14px;
        line-height: 1.5;
        background: #fff;
      }
      .pell-content:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--primary-ring-color);
      }
      .pell-actionbar {
        background-color: #f9f9f9;
        padding: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .pell-button {
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 3px;
        cursor: pointer;
        height: 30px;
        min-width: 30px;
        margin: 0 2px;
        padding: 4px 6px;
        vertical-align: middle;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .pell-button-selected {
        background-color: #ddd;
        border-color: #bbb;
      }
      .pell-button:hover {
        background-color: #eee;
      }
      .pell-button [class*="ri-"] {
        font-size: 18px;
        line-height: 1;
        vertical-align: middle;
      }
      .custom-pell-select {
        font-size: 14px;
        border: 1px solid #ccc;
        background: #fff;
        border-radius: 3px;
        height: 30px;
        margin: 0 2px;
        padding: 4px 6px;
        cursor: pointer;
      }
      .custom-pell-color {
        padding: 0 2px;
        width: 40px;
        height: 30px;
        margin: 0 2px;
        border: 1px solid #ccc;
        border-radius: 3px;
        cursor: pointer;
        background: #fff;
      }
    </style>
  </head>
  <body class="theme-festive">
    <div id="layout-root" class="flex flex-row w-screen h-screen">
      <div id="qr-code-area">
        <div class="flex flex-1 flex-col min-h-0">
          <div id="alipay-qr-container" class="qr-container" style="display: none">
            <p class="vertical-text">支付宝</p>
            <img id="qr-alipay-img" src="" alt="Alipay" />
          </div>
          <div id="wechat-qr-container" class="qr-container" style="display: none">
            <p class="vertical-text">微信</p>
            <img id="qr-wechat-img" src="" alt="WeChat Pay" />
          </div>
        </div>
        <div id="custom-text-display" class="custom-text-area"></div>
      </div>

      <div id="app-container" class="hidden flex-1 h-full">
        <div class="gift-book-frame">
          <div class="text-center mb-6">
            <h1 id="event-title" class="text-4xl font-bold" style="color: var(--primary-color); letter-spacing: 8px">礼簿</h1>
          </div>
          <div id="gift-book-content" class="gift-book-content"></div>
        </div>
        
    <div id="top-right-controls">
      <button id="settings-btn" title="设置">
        <i id="settings-icon" class="ri-settings-3-line text-2xl"></i>
      </button>
      <button id="fullscreen-btn" title="全屏/退出全屏">
        <i id="fullscreen-icon" class="ri-fullscreen-line text-2xl"></i>
      </button>
    </div>
      </div>
    </div>


    <div id="fullscreen-hint">按 F11 进入全屏以获得最佳效果</div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div id="modal" class="bg-white p-6 rounded-lg shadow-xl">
        <h3 id="modal-title" class="text-xl font-bold mb-4 text-center"></h3>
        <div id="modal-content"></div>
        <div id="modal-actions" class="mt-6 flex justify-end space-x-3"></div>
      </div>
    </div>

    <script src="./static/pell.min.js"></script>

    <script>
      /**
       * 简易缓存管理器
       */
      const CacheManager = {
        CACHE_NAME: "guest-screen-qr-cache",
        SETTINGS_KEY: "guest-screen-settings",

        async storeImage(key, file) {
          try {
            const cache = await caches.open(this.CACHE_NAME);
            const response = new Response(file);
            await cache.put(key, response);
            console.log(`Image ${key} stored in cache.`);
          } catch (error) {
            console.error(`Failed to store image ${key}:`, error);
          }
        },

        async getImage(key) {
          try {
            const cache = await caches.open(this.CACHE_NAME);
            const response = await cache.match(key);
            if (response) {
              return response.blob();
            }
            return null;
          } catch (error) {
            console.error(`Failed to get image ${key}:`, error);
            return null;
          }
        },

        // 新增: 删除图片缓存
        async deleteImage(key) {
          try {
            const cache = await caches.open(this.CACHE_NAME);
            await cache.delete(key);
            console.log(`Image ${key} deleted from cache.`);
          } catch (error) {
            console.error(`Failed to delete image ${key}:`, error);
          }
        },

        storeSettings(settings) {
          try {
            const currentSettings = this.getSettings();
            const newSettings = { ...currentSettings, ...settings };
            localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(newSettings));
          } catch (error) {
            console.error("Failed to store settings:", error);
          }
        },

        getSettings() {
          try {
            const settings = localStorage.getItem(this.SETTINGS_KEY);
            const defaults = { layout: "hidden", customText: "" };
            return settings ? { ...defaults, ...JSON.parse(settings) } : defaults;
          } catch (error) {
            console.error("Failed to get settings:", error);
            return { layout: "hidden", customText: "" };
          }
        },
      };

      // 工具函数：隐藏姓名
      function maskName(name, hidePrivacy, isLatest) {
        // 当 hidePrivacy 为 true 时，显示所有姓名的完整信息，不进行任何脱敏处理
        if (hidePrivacy) {
          return name;
        }
        // 当 hidePrivacy 为 false 时，最新记录和历史记录都只显示完整姓名（不进行脱敏，因为金额会被隐藏）
        return name;
      }

      // 副屏状态管理
      class GuestScreen {
        constructor() {
          this.currentData = null;
          this.cacheDOMElements();
        }

        cacheDOMElements() {
          const $ = (id) => document.getElementById(id);
          this.appContainer = $("app-container");
          this.eventTitle = $("event-title");
          this.giftBookContent = $("gift-book-content");
          this.fullscreenBtn = $("fullscreen-btn");
          this.fullscreenIcon = $("fullscreen-icon");
          this.fullscreenHint = $("fullscreen-hint");

          this.layoutRoot = $("layout-root");
          this.qrCodeArea = $("qr-code-area");
          this.qrAlipayContainer = $("alipay-qr-container");
          this.qrWechatContainer = $("wechat-qr-container");
          this.qrAlipayImg = $("qr-alipay-img");
          this.qrWechatImg = $("qr-wechat-img");
          this.customTextDisplay = $("custom-text-display");

          this.settingsBtn = $("settings-btn");
          this.modalContainer = $("modal-container");
          this.modal = $("modal");
          this.modalTitle = $("modal-title");
          this.modalContent = $("modal-content");
          this.modalActions = $("modal-actions");

          this.pendingAlipayFile = null;
          this.pendingWechatFile = null;
          // 新增: 标记是否清空
          this.alipayCleared = false;
          this.wechatCleared = false;
        }

        init() {
          window.addEventListener("message", (e) => this.handleMessage(e));
          window.opener?.postMessage({ type: "guest_screen_ready" }, "*");
          this.bindControlEvents();
          this.loadAndApplySettings();
        }

        bindControlEvents() {
          document.addEventListener("fullscreenchange", () => {
            if (document.fullscreenElement) {
              this.fullscreenHint.style.display = "none";
              this.fullscreenIcon.className = "ri-fullscreen-exit-line text-2xl";
            } else {
              this.fullscreenIcon.className = "ri-fullscreen-line text-2xl";
            }
          });

          this.fullscreenBtn.addEventListener("click", () => {
            if (!document.fullscreenElement) {
              document.documentElement.requestFullscreen().catch((err) => {
                console.error(`Error attempting to enable full-screen mode: ${err.message}`);
              });
            } else {
              document.exitFullscreen();
            }
          });

          this.settingsBtn.addEventListener("click", () => this.showSettingsModal());
        }

        handleMessage(event) {
          const { type, data } = event.data || {};
          switch (type) {
            case "guest_screen_update":
              this.updateDisplay(data);
              break;
            case "guest_screen_heartbeat":
              break;
          }
        }

        updateDisplay(data) {
          if (!data) return;
          this.currentData = data;
          document.body.className = data.theme || "theme-festive";
          this.eventTitle.textContent = data.eventName || "礼簿";
          this.renderGiftBook(data);
          this.appContainer.classList.remove("hidden");
        }

        renderGiftBook(data) {
          const { gifts, hidePrivacy, typeText } = data;
          const ITEMS_PER_PAGE = 12;
          const latestGiftId = gifts[gifts.length - 1]?.id;
          const displayGifts = [...gifts];
          while (displayGifts.length < ITEMS_PER_PAGE) {
            displayGifts.push(null);
          }
          const nameRow = document.createElement("div");
          nameRow.className = "gift-book-row";
          
          // 当 hidePrivacy 为 true 时只显示姓名，为 false 时显示完整信息
          const showGiftInfo = !hidePrivacy;
          let typeRow, amountRow, nameTitleRow;
          
          // 当开启脱敏时，在姓名上方添加标题行
          if (hidePrivacy) {
            nameTitleRow = document.createElement("div");
            nameTitleRow.className = "gift-book-row title-row";
            for (let i = 0; i < ITEMS_PER_PAGE; i++) {
              const titleCell = document.createElement("div");
              titleCell.className = "book-cell name-cell";
              titleCell.innerHTML = '<div class="name title">姓名</div>';
              nameTitleRow.appendChild(titleCell);
            }
          }
          
          if (showGiftInfo) {
            typeRow = document.createElement("div");
            typeRow.className = "gift-book-row";
            amountRow = document.createElement("div");
            amountRow.className = "gift-book-row";
          }
          
          displayGifts.forEach((gift) => {
            const nameCell = document.createElement("div");
            nameCell.className = "book-cell name-cell";
            if (gift) {
              const isLatest = gift.id === latestGiftId;
              const displayName = maskName(gift.name, hidePrivacy, isLatest);
              const formattedName = displayName.length === 2 ? `${displayName[0]}\u3000${displayName[1]}` : displayName;
              nameCell.innerHTML = `<div class="name ${displayName.length > 4 ? "scale" : ""}">${formattedName}</div>`;
              if (isLatest) nameCell.classList.add("latest-entry");
            }
            nameRow.appendChild(nameCell);
            
            if (showGiftInfo) {
              const typeCell = document.createElement("div");
              typeCell.className = "book-cell type-cell";
              typeCell.textContent = typeText || "贺礼";
              typeRow.appendChild(typeCell);
              
              const amountCell = document.createElement("div");
              amountCell.className = "book-cell amount-cell";
              if (gift) {
                const amountChinese = gift.amountChinese;
                amountCell.innerHTML = `
                  <div class="amount-chinese ${amountChinese.length > 16 ? "scale" : ""}">${amountChinese}</div>
                  <div class="amount-numeric ${Math.abs(gift.amount).toString().length > 8 ? "scale" : ""}>￥${gift.amount}</div>
                `;
                if (gift.id === latestGiftId) amountCell.classList.add("latest-entry");
              }
              amountRow.appendChild(amountCell);
            }
          });
          
          this.giftBookContent.innerHTML = "";
          
          // 根据不同的显示模式设置行高比例
          if (hidePrivacy) {
            // 脱敏模式：标题行矮，姓名行高
            this.giftBookContent.style.gridTemplateRows = "1fr 3fr";
          } else {
            // 非脱敏模式：恢复默认比例
            this.giftBookContent.style.gridTemplateRows = "3fr 1fr 3fr";
          }
          
          // 如果有姓名标题行，先添加标题行
          if (nameTitleRow) {
            this.giftBookContent.appendChild(nameTitleRow);
          }
          
          this.giftBookContent.appendChild(nameRow);
          
          if (showGiftInfo) {
            this.giftBookContent.appendChild(typeRow);
            this.giftBookContent.appendChild(amountRow);
          }
        }

        async loadAndApplySettings() {
          const settings = CacheManager.getSettings();
          const alipayBlob = await CacheManager.getImage("alipay-qr");
          const wechatBlob = await CacheManager.getImage("wechat-qr");
          const customText = settings.customText || "";

          const hasQrCodes = !!alipayBlob || !!wechatBlob;
          const hasCustomText = customText && customText.trim() !== "";
          
          this.applyLayout(settings.layout, hasQrCodes, hasCustomText);

          if (alipayBlob) {
            this.qrAlipayImg.src = URL.createObjectURL(alipayBlob);
            this.qrAlipayContainer.style.display = "flex";
          } else {
            this.qrAlipayImg.src = "";
            this.qrAlipayContainer.style.display = "none";
          }
          if (wechatBlob) {
            this.qrWechatImg.src = URL.createObjectURL(wechatBlob);
            this.qrWechatContainer.style.display = "flex";
          } else {
            this.qrWechatImg.src = "";
            this.qrWechatContainer.style.display = "none";
          }
          
          // 渲染自定义文字，支持markdown
          this.customTextDisplay.innerHTML = this.renderMarkdown(customText);
        }

        applyLayout(layout, hasQrCodes, hasCustomText) {
          this.layoutRoot.classList.remove("flex-row", "flex-row-reverse");
          
          // 显示二维码区域的条件：有二维码内容 或 有自定义文字
          const showQrArea = hasQrCodes || hasCustomText;
          
          if (showQrArea) {
            this.qrCodeArea.style.display = "flex";
            
            // 控制二维码区域的布局方向
            if (hasQrCodes) {
              if (layout === "left") this.layoutRoot.classList.add("flex-row");
              else if (layout === "right") this.layoutRoot.classList.add("flex-row-reverse");
            }
            
            // 根据是否有二维码调整自定义文字区域的样式
            const qrContainerWrapper = this.qrCodeArea.querySelector(".flex.flex-1");
            const customTextArea = this.qrCodeArea.querySelector(".custom-text-area");
            
            if (hasQrCodes) {
              qrContainerWrapper.style.display = "flex";
              customTextArea.style.marginTop = "1.5rem";
              customTextArea.style.paddingTop = "1.5rem";
              customTextArea.style.borderTop = "2px dashed var(--primary-border-color)";
            } else {
              qrContainerWrapper.style.display = "none";
              customTextArea.style.marginTop = "0";
              customTextArea.style.paddingTop = "1.5rem";
              customTextArea.style.borderTop = "none";
            }
          } else {
            this.qrCodeArea.style.display = "none";
          }
        }
        
        // 简单的markdown渲染函数
        renderMarkdown(text) {
          if (!text) return "";
          
          // 转换标题，添加更明显的样式
          text = text.replace(/^# (.*$)/gm, '<h1 style="margin: 0.5rem 0; font-size: 2rem; font-weight: bold;">$1</h1>');
          text = text.replace(/^## (.*$)/gm, '<h2 style="margin: 0.4rem 0; font-size: 1.5rem; font-weight: bold;">$1</h2>');
          text = text.replace(/^### (.*$)/gm, '<h3 style="margin: 0.3rem 0; font-size: 1.2rem; font-weight: bold;">$1</h3>');
          
          // 转换粗体和斜体
          text = text.replace(/\*\*(.*?)\*\*/gm, '<strong>$1</strong>');
          text = text.replace(/\*(.*?)\*/gm, '<em>$1</em>');
          
          // 转换链接
          text = text.replace(/\[(.*?)\]\((.*?)\)/gm, '<a href="$2" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color); text-decoration: underline;">$1</a>');
          
          // 转换代码块
          text = text.replace(/```(.*?)```/gs, '<pre style="background-color: #f5f5f5; padding: 1rem; border-radius: 4px; margin: 0.5rem 0; font-family: monospace; font-size: 0.9rem;">$1</pre>');
          
          // 转换行内代码
          text = text.replace(/`(.*?)`/gm, '<code style="background-color: #f5f5f5; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: monospace; font-size: 0.9rem;">$1</code>');
          
          // 转换有序列表
          text = text.replace(/^\d+\.\s(.*$)/gm, '<li style="margin-left: 1.5rem;">$1</li>');
          text = text.replace(/<\/li>\s*<li/gm, '</li><li');
          text = text.replace(/(<li[^>]*>.*?<\/li>)/gs, '<ol style="margin: 0.5rem 0;">$1</ol>');
          
          // 转换无序列表
          text = text.replace(/^[-\*]\s(.*$)/gm, '<li style="margin-left: 1.5rem;">$1</li>');
          text = text.replace(/<\/li>\s*<li/gm, '</li><li');
          text = text.replace(/(<li[^>]*>.*?<\/li>)/gs, '<ul style="margin: 0.5rem 0;">$1</ul>');
          
          // 转换换行
          text = text.replace(/\n/gm, '<br>');
          
          return text;
        }

        async showSettingsModal() {
          this.pendingAlipayFile = null;
          this.pendingWechatFile = null;
          this.alipayCleared = false; // 重置状态
          this.wechatCleared = false; // 重置状态

          const settings = CacheManager.getSettings();
          const currentLayout = settings.layout || "hidden";
          const customText = settings.customText || "";

          const alipayBlob = await CacheManager.getImage("alipay-qr");
          const wechatBlob = await CacheManager.getImage("wechat-qr");
          const alipaySrc = alipayBlob ? URL.createObjectURL(alipayBlob) : "";
          const wechatSrc = wechatBlob ? URL.createObjectURL(wechatBlob) : "";

          this.modalTitle.textContent = "副屏显示设置";
          this.modalContent.innerHTML = `
            <div class="space-y-6 text-left">
              <div>
                <label class="block text-sm font-medium text-gray-700">显示收款码</label>
                <div class="flex space-x-4 mt-2">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="layout-position" value="hidden" class="themed-text-radio themed-ring" ${currentLayout === "hidden" ? "checked" : ""}>
                    <span>不显示</span>
                  </label>
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="layout-position" value="left" class="themed-text-radio themed-ring" ${currentLayout === "left" ? "checked" : ""}>
                    <span>左侧显示</span>
                  </label>
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="layout-position" value="right" class="themed-text-radio themed-ring" ${currentLayout === "right" ? "checked" : ""}>
                    <span>右侧显示</span>
                  </label>
                </div>
              </div>

              <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="flex-1">
                  <div class="flex justify-between items-center mb-1">
                    <label class="block text-sm font-medium text-gray-700">支付宝 收款码</label>
                    <button id="alipay-clear-btn" class="text-xs text-red-600 hover:underline ${alipaySrc ? "" : "hidden"}">清空</button>
                  </div>
                  <input type="file" id="alipay-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                  <img id="alipay-preview" src="${alipaySrc}" class="mt-2 rounded-lg ${alipaySrc ? "" : "hidden"} max-w-full h-auto max-h-32 object-contain border p-1 bg-white">
                </div>
                <div class="flex-1">
                  <div class="flex justify-between items-center mb-1">
                    <label class="block text-sm font-medium text-gray-700">微信 收款码</label>
                    <button id="wechat-clear-btn" class="text-xs text-red-600 hover:underline ${wechatSrc ? "" : "hidden"}">清空</button>
                  </div>
                  <input type="file" id="wechat-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300">
                  <img id="wechat-preview" src="${wechatSrc}" class="mt-2 rounded-lg ${wechatSrc ? "" : "hidden"} max-w-full h-auto max-h-32 object-contain border p-1 bg-white">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">自定义文字</label>
                <div id="pell-editor-container" class="mt-1"></div>
              </div>
            </div>
          `;

          this.modalActions.innerHTML = `
            <button id="modal-cancel-btn" class="themed-button-secondary">取消</button>
            <button id="modal-save-btn" class="themed-button-primary">保存设置</button>
          `;

          // 创建一个简单的textarea用于输入markdown
          const editorContainer = document.getElementById("pell-editor-container");
          const textarea = document.createElement("textarea");
          textarea.className = "w-full h-40 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-color focus:border-primary-color resize-none font-mono text-sm";
          textarea.placeholder = "请输入markdown格式的文本...\n\n示例:\n# 标题\n**粗体** *斜体*\n[链接](http://example.com)";
          textarea.value = customText;
          editorContainer.innerHTML = "";
          editorContainer.appendChild(textarea);
          
          // 模拟editor对象，以便在handleSaveSettings中使用
          const editor = {
            content: {
              textContent: () => textarea.value,
              innerText: () => textarea.value,
              value: textarea.value
            }
          };
          
          // 更新editor.content.value当textarea内容变化时
          textarea.addEventListener("input", () => {
            editor.content.value = textarea.value;
          });

          document.getElementById("modal-cancel-btn").onclick = () => this.closeSettingsModal();
          document.getElementById("modal-save-btn").onclick = () => this.handleSaveSettings(editor);
          document.getElementById("alipay-upload").onchange = (e) => this.handleFilePreview(e, "alipay");
          document.getElementById("wechat-upload").onchange = (e) => this.handleFilePreview(e, "wechat");
          document.getElementById("alipay-clear-btn").onclick = () => this.handleClearPreview("alipay");
          document.getElementById("wechat-clear-btn").onclick = () => this.handleClearPreview("wechat");

          this.modalContainer.classList.remove("hidden");
        }

        handleClearPreview(type) {
          const preview = document.getElementById(`${type}-preview`);
          const uploadInput = document.getElementById(`${type}-upload`);
          const clearBtn = document.getElementById(`${type}-clear-btn`);

          preview.src = "";
          preview.classList.add("hidden");
          uploadInput.value = "";
          clearBtn.classList.add("hidden");

          if (type === "alipay") {
            this.pendingAlipayFile = null;
            this.alipayCleared = true;
          } else if (type === "wechat") {
            this.pendingWechatFile = null;
            this.wechatCleared = true;
          }
        }

        closeSettingsModal() {
          this.modalContainer.classList.add("hidden");
          this.modalContent.innerHTML = "";
          this.modalActions.innerHTML = "";
        }

        handleFilePreview(event, type) {
          const file = event.target.files[0];
          if (!file) return;

          if (type === "alipay") {
            this.pendingAlipayFile = file;
            this.alipayCleared = false;
          }
          if (type === "wechat") {
            this.pendingWechatFile = file;
            this.wechatCleared = false;
          }

          const preview = document.getElementById(`${type}-preview`);
          const clearBtn = document.getElementById(`${type}-clear-btn`);
          const oldSrc = preview.src;
          preview.src = URL.createObjectURL(file);
          preview.classList.remove("hidden");
          clearBtn.classList.remove("hidden");

          preview.onload = () => {
            if (oldSrc.startsWith("blob:")) {
              URL.revokeObjectURL(oldSrc);
            }
          };
        }

        async handleSaveSettings(editor) {
          try {
            // 1. 根据标记和新文件更新图片
            if (this.alipayCleared) {
              await CacheManager.deleteImage("alipay-qr");
            } else if (this.pendingAlipayFile) {
              await CacheManager.storeImage("alipay-qr", this.pendingAlipayFile);
            }

            if (this.wechatCleared) {
              await CacheManager.deleteImage("wechat-qr");
            } else if (this.pendingWechatFile) {
              await CacheManager.storeImage("wechat-qr", this.pendingWechatFile);
            }

            // 2. 保存布局和文字
            const layout = document.querySelector('input[name="layout-position"]:checked').value;
            // 获取编辑器中的纯文本内容，不包含HTML标签
            const customText = typeof editor.content.textContent === 'function' ? editor.content.textContent() : (editor.content.value || "");
            CacheManager.storeSettings({ layout, customText });

            // 3. 重新加载并应用
            await this.loadAndApplySettings();

            // 4. 关闭弹窗
            this.closeSettingsModal();
          } catch (error) {
            console.error("保存设置失败:", error);
            alert("保存设置失败，请重试。");
          }
        }
      }

      const guestScreen = new GuestScreen();
      guestScreen.init();

      document.addEventListener("keydown", (e) => {
        if (e.target.closest(".pell-content")) return;
        if (e.key === "F11") {
          e.preventDefault();
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch((err) => {
              console.error(`Error attempting to enable full-screen mode: ${err.message}`);
            });
          } else {
            document.exitFullscreen();
          }
        }
        if (e.key === "Escape" && !document.fullscreenElement) {
          if (confirm("确定要关闭副屏吗？")) {
            window.close();
          }
        }
      });
    </script>
  </body>
</html>